<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DetailGest Titan v12.0 | Enterprise OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --gold: #eab308; --deep: #020617; }
        body { background: var(--deep); color: #f8fafc; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .titan-glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .active-tab { background: var(--gold) !important; color: #000 !important; font-weight: 800; transform: translateX(5px); }
        .sidebar-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        input, select { background: #0f172a !important; border: 1px solid #334155 !important; color: white !important; border-radius: 14px; padding: 14px; width: 100%; transition: 0.2s; }
        input:focus { border-color: var(--gold) !important; ring: 2px var(--gold); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .offline { background: #ef4444; }
        #sidebar { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (max-width: 1024px) { #sidebar { position: fixed; transform: translateX(-100%); z-index: 100; height: 100%; } #sidebar.open { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="loading-screen" class="fixed inset-0 z-[200] bg-slate-950 flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-gold border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-gold font-black tracking-widest animate-pulse">TITAN OS v12.0</h2>
    </div>

    <div id="login-view" class="h-screen flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1601362840469-51e4d8d59085?q=80&w=2000')] bg-cover">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md p-8 titan-glass rounded-[3rem] border-t-4 border-gold mx-4">
            <h1 class="text-4xl font-black text-white italic text-center mb-2">DETAILGEST</h1>
            <p class="text-center text-gold text-[10px] font-bold tracking-[0.4em] mb-10 uppercase">Enterprise System</p>
            <form onsubmit="Auth.handleLogin(event)" class="space-y-4">
                <input type="text" id="user" placeholder="Email / Usuario" required>
                <input type="password" id="pass" placeholder="Contraseña" required>
                <button type="submit" class="w-full bg-gold text-black font-black py-4 rounded-2xl hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-tighter">Entrar al Sistema</button>
            </form>
        </div>
    </div>

    <div id="app-view" class="hidden h-screen flex overflow-hidden">
        <aside id="sidebar" class="w-72 titan-glass border-r border-slate-800 flex flex-col p-6 shrink-0">
            <div class="flex justify-between items-center mb-10">
                <span class="text-2xl font-black text-gold italic">TITAN</span>
                <button onclick="UI.toggleMenu()" class="lg:hidden text-white"><i class="fas fa-times"></i></button>
            </div>
            <nav id="menu-items" class="flex-1 space-y-2 overflow-y-auto"></nav>
            <div class="pt-6 border-t border-slate-800 space-y-4">
                <div class="flex items-center gap-3 px-2">
                    <span id="sync-icon" class="status-dot online"></span>
                    <span id="sync-text" class="text-[10px] font-bold text-slate-400 uppercase">Sincronizado</span>
                </div>
                <button onclick="location.reload()" class="w-full p-4 bg-red-500/10 text-red-500 rounded-2xl font-black text-xs uppercase hover:bg-red-500/20">Cerrar Sesión</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0">
            <header class="h-20 titan-glass border-b border-slate-800 px-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="UI.toggleMenu()" class="lg:hidden text-gold text-xl"><i class="fas fa-bars"></i></button>
                    <h2 id="view-title" class="text-xl font-black uppercase italic text-white">Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p id="profile-name" class="text-xs font-black text-white uppercase"></p>
                        <p id="profile-company" class="text-[10px] text-gold font-bold uppercase"></p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gold/10 flex items-center justify-center border border-gold/20">
                        <i class="fas fa-user-tie text-gold"></i>
                    </div>
                </div>
            </header>
            <div id="content" class="flex-1 overflow-y-auto p-4 md:p-8"></div>
        </main>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-[150] bg-slate-950/95 backdrop-blur-xl p-4 flex items-center justify-center">
        <div id="modal-body" class="titan-glass w-full max-w-xl p-8 rounded-[2.5rem] relative"></div>
    </div>

    <script>
        const SB_URL = 'https://itahtywhhaecjakgtnzu.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0YWh0eXdoaGFlY2pha2d0bnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMjYyODIsImV4cCI6MjA4NTkwMjI4Mn0.ARQ9W_Rpj8rp_xo88TbTjbdwT6o75J7sCPlConcoshw';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let State = {
            user: null,
            cart: [],
            isOnline: navigator.onLine,
            currentView: 'DASHBOARD'
        };

        const Auth = {
            async handleLogin(e) {
                e.preventDefault();
                UI.loader(true);
                const u = document.getElementById('user').value;
                const p = document.getElementById('pass').value;

                // Bypass Master
                if(u === 'admin@detailgest.com' && p === 'master2026') {
                    State.user = { id: 'master', username: 'Super Admin', role: 'super_admin', company_id: 'all' };
                    return this.initApp();
                }

                const { data, error } = await sb.from('users').select('*, companies(*)').eq('username', u).eq('password_hash', p).single();
                if(data) {
                    State.user = data;
                    this.initApp();
                } else {
                    alert("Credenciales inválidas");
                    UI.loader(false);
                }
            },
            initApp() {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('profile-name').innerText = State.user.username;
                document.getElementById('profile-company').innerText = State.user.companies?.name || 'Central';
                UI.renderMenu();
                UI.navigate(State.user.role === 'super_admin' ? 'EMPRESAS' : 'DASHBOARD');
                UI.loader(false);
            }
        };

        const UI = {
            loader(s) { document.getElementById('loading-screen').classList.toggle('hidden', !s); },
            toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); },
            renderMenu() {
                const adminMenu = [
                    {id:'DASHBOARD', i:'fa-rocket'}, {id:'CAJA', i:'fa-cash-register'}, 
                    {id:'AGENDA', i:'fa-calendar-day'}, {id:'CLIENTES', i:'fa-users'},
                    {id:'SERVICIOS', i:'fa-concierge-bell'}, {id:'STAFF', i:'fa-user-shield'},
                    {id:'REPORTES', i:'fa-chart-bar'}
                ];
                const saMenu = [{id:'EMPRESAS', i:'fa-building'}, {id:'SISTEMA', i:'fa-server'}];
                const list = State.user.role === 'super_admin' ? saMenu : adminMenu;
                document.getElementById('menu-items').innerHTML = list.map(m => `
                    <div onclick="UI.navigate('${m.id}')" id="nav-${m.id}" class="sidebar-item flex items-center gap-4 p-4 rounded-2xl text-slate-400 font-bold text-sm">
                        <i class="fas ${m.i} w-5"></i> ${m.id}
                    </div>
                `).join('');
            },
            navigate(view) {
                State.currentView = view;
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active-tab'));
                document.getElementById(`nav-${view}`)?.classList.add('active-tab');
                document.getElementById('view-title').innerText = view;
                this.toggleMenu(false);
                this.renderContent();
            },
            async renderContent() {
                const container = document.getElementById('content');
                container.innerHTML = '<div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-6 py-1"><div class="h-2 bg-slate-700 rounded"></div><div class="h-2 bg-slate-700 rounded"></div></div></div>';
                
                if(State.currentView === 'EMPRESAS') Views.sa_empresas(container);
                if(State.currentView === 'DASHBOARD') Views.dashboard(container);
                if(State.currentView === 'CAJA') Views.caja(container);
                if(State.currentView === 'AGENDA') Views.agenda(container);
                if(State.currentView === 'CLIENTES') Views.clientes(container);
                if(State.currentView === 'SERVICIOS') Views.servicios(container);
                if(State.currentView === 'STAFF') Views.staff(container);
            }
        };

        const Views = {
            async dashboard(c) {
                const { data: sales } = await sb.from('sales').select('*').eq('company_id', State.user.company_id);
                const total = sales?.reduce((a,b) => a + b.total_final, 0) || 0;
                c.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
                        <div class="titan-glass p-8 rounded-[2.5rem] border-l-4 border-gold">
                            <p class="text-[10px] font-black text-slate-500 uppercase mb-2">Facturación Bruta</p>
                            <h3 class="text-4xl font-black">${total.toLocaleString()} <span class="text-xs text-gold">Gs</span></h3>
                        </div>
                        <div class="titan-glass p-8 rounded-[2.5rem] border-l-4 border-blue-500">
                            <p class="text-[10px] font-black text-slate-500 uppercase mb-2">Servicios Registrados</p>
                            <h3 class="text-4xl font-black">${sales?.length || 0}</h3>
                        </div>
                    </div>
                    <div class="titan-glass p-10 rounded-[3rem] h-96"><canvas id="mainChart"></canvas></div>`;
                new Chart(document.getElementById('mainChart'), {
                    type: 'line',
                    data: {
                        labels: sales.map(s => s.created_at.slice(5,10)).slice(-10),
                        datasets: [{ label: 'Ventas', data: sales.map(s => s.total_final).slice(-10), borderColor: '#eab308', tension: 0.4 }]
                    }
                });
            },

            async caja(c) {
                const [servs, clis] = await Promise.all([
                    sb.from('services_list').select('*').eq('company_id', State.user.company_id),
                    sb.from('clients').select('*').eq('company_id', State.user.company_id)
                ]);
                c.innerHTML = `
                    <div class="flex flex-col xl:flex-row gap-8 h-full">
                        <div class="flex-1 grid grid-cols-2 md:grid-cols-3 gap-4 h-fit">
                            ${servs.data.map(s => `
                                <button onclick="Pos.add('${s.name}', ${s.price})" class="titan-glass p-8 rounded-3xl hover:border-gold transition-all active:scale-95 text-center">
                                    <h4 class="text-[10px] font-black text-slate-500 uppercase mb-1">${s.name}</h4>
                                    <p class="text-2xl font-black text-white">${s.price.toLocaleString()}</p>
                                </button>
                            `).join('')}
                        </div>
                        <div class="w-full xl:w-[400px] titan-glass p-8 rounded-[3rem] flex flex-col h-fit sticky top-0">
                            <h3 class="font-black text-gold italic mb-6 uppercase tracking-tighter">Terminal Punto de Venta</h3>
                            <select id="p-client" class="mb-4"><option value="">CONSUMIDOR FINAL</option>${clis.data.map(i => `<option value="${i.id}">${i.name}</option>`)}</select>
                            <div id="cart-list" class="flex-1 space-y-3 mb-6 min-h-[100px] border-y border-white/5 py-6"></div>
                            <div class="flex justify-between items-center mb-8">
                                <span class="font-black text-slate-500 uppercase text-xs">Total Cobro</span>
                                <span id="p-total" class="text-4xl font-black italic">0 Gs</span>
                            </div>
                            <button onclick="Pos.checkout()" class="w-full bg-gold text-black py-5 rounded-2xl font-black uppercase text-xl shadow-2xl shadow-gold/20">Registrar Venta</button>
                        </div>
                    </div>`;
                State.cart = [];
            },

            async agenda(c) {
                const { data } = await sb.from('sales').select('*, clients(name)').eq('company_id', State.user.company_id).order('created_at', {ascending: false});
                c.innerHTML = `<div class="grid gap-4">${data.map(s => `
                    <div class="titan-glass p-6 rounded-3xl flex justify-between items-center border-l-8 border-gold/50">
                        <div>
                            <span class="text-[9px] font-black text-gold bg-gold/10 px-2 py-1 rounded-md uppercase mb-2 inline-block">${s.created_at.replace('T', ' ').slice(0,16)}</span>
                            <h4 class="text-xl font-black uppercase">${s.clients?.name || 'Cliente Ocasional'}</h4>
                            <p class="text-xs font-bold text-slate-500 italic">${s.details}</p>
                        </div>
                        <div class="flex items-center gap-6">
                            <span class="text-2xl font-black">${s.total_final.toLocaleString()} Gs</span>
                            <div class="flex gap-2">
                                <button onclick="Actions.editSale('${s.id}', '${s.details}', ${s.total_final})" class="w-10 h-10 rounded-xl bg-blue-500/10 text-blue-500 flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                <button onclick="Actions.deleteSale('${s.id}')" class="w-10 h-10 rounded-xl bg-red-500/10 text-red-500 flex items-center justify-center"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`).join('')}</div>`;
            }
        };

        const Pos = {
            add(n, p) { State.cart.push({n, p}); this.update(); },
            update() {
                const l = document.getElementById('cart-list');
                const t = document.getElementById('p-total');
                l.innerHTML = State.cart.map((i, x) => `
                    <div class="flex justify-between items-center bg-white/5 p-3 rounded-xl">
                        <span class="text-xs font-black uppercase">${i.n}</span>
                        <button onclick="Pos.rem(${x})" class="text-red-500"><i class="fas fa-times-circle"></i></button>
                    </div>`).join('');
                t.innerText = State.cart.reduce((a,b) => a + b.p, 0).toLocaleString() + ' Gs';
            },
            rem(x) { State.cart.splice(x,1); this.update(); },
            async checkout() {
                const total = State.cart.reduce((a,b) => a + b.p, 0);
                if(!total) return alert("Caja vacía");
                UI.loader(true);
                const { error } = await sb.from('sales').insert([{
                    company_id: State.user.company_id,
                    total_final: total,
                    details: State.cart.map(i => i.n).join(', '),
                    client_id: document.getElementById('p-client').value || null
                }]);
                UI.loader(false);
                if(!error) { alert("¡Sincronización Exitosa!"); UI.navigate('CAJA'); }
            }
        };

        const Actions = {
            editSale(id, det, tot) {
                const m = document.getElementById('modal');
                const b = document.getElementById('modal-body');
                m.classList.remove('hidden');
                b.innerHTML = `
                    <h3 class="text-2xl font-black text-gold mb-8 italic uppercase">Modificar Registro</h3>
                    <div class="space-y-4">
                        <input id="e-det" value="${det}">
                        <input id="e-tot" type="number" value="${tot}">
                        <div class="flex gap-4">
                            <button onclick="Actions.saveEdit('${id}')" class="flex-1 bg-gold text-black font-black py-4 rounded-xl">GUARDAR</button>
                            <button onclick="document.getElementById('modal').classList.add('hidden')" class="flex-1 bg-slate-800 text-white font-black py-4 rounded-xl">CANCELAR</button>
                        </div>
                    </div>`;
            },
            async saveEdit(id) {
                UI.loader(true);
                await sb.from('sales').update({
                    details: document.getElementById('e-det').value,
                    total_final: document.getElementById('e-tot').value
                }).eq('id', id);
                document.getElementById('modal').classList.add('hidden');
                UI.loader(false);
                UI.navigate('AGENDA');
            },
            async deleteSale(id) {
                if(confirm("¿Seguro de borrar?")) {
                    UI.loader(true);
                    await sb.from('sales').delete().eq('id', id);
                    UI.loader(false);
                    UI.navigate('AGENDA');
                }
            }
        };

        window.addEventListener('online', () => {
            document.getElementById('sync-icon').className = 'status-dot online';
            document.getElementById('sync-text').innerText = 'Online';
        });
        window.addEventListener('offline', () => {
            document.getElementById('sync-icon').className = 'status-dot offline';
            document.getElementById('sync-text').innerText = 'Modo Offline';
        });

        setTimeout(() => UI.loader(false), 1500);
    </script>
</body>
</html>