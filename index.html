<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DetailGest | Reactive Store Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --accent: #eab308; --bg: #060910; }
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: var(--bg); color: #f1f5f9; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .sidebar-item { padding: 0.8rem 1.2rem; margin: 0.2rem 0.5rem; border-radius: 1rem; display: flex; align-items: center; gap: 12px; cursor: pointer; color: #94a3b8; font-weight: 600; font-size: 13px; transition: 0.3s; }
        .sidebar-item.active { background: var(--accent); color: #000; }
        input, select { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; border-radius: 12px; padding: 12px; outline: none; width: 100%; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body>

    <section id="auth-view" class="h-full flex items-center justify-center p-6">
        <div class="max-w-md w-full glass p-10 rounded-[2.5rem] border-t-4 border-yellow-500 text-center">
            <h1 class="text-4xl font-black text-white italic mb-8 uppercase tracking-tighter">DetailGest</h1>
            <form onsubmit="App.login(event)" class="space-y-4">
                <input type="text" id="user" placeholder="Usuario" required>
                <input type="password" id="pass" placeholder="Contraseña" required>
                <button type="submit" class="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl uppercase tracking-tighter hover:brightness-110">Ingresar</button>
            </form>
        </div>
    </section>

    <section id="app-view" class="hidden h-screen flex">
        <aside class="w-64 glass border-r border-slate-800 flex flex-col py-6">
            <div class="px-8 mb-10 text-2xl font-black italic text-yellow-500">DG PRO</div>
            <nav id="menu" class="flex-1"></nav>
            <div class="px-4">
                <button onclick="location.reload()" class="w-full p-4 text-red-500 font-bold text-xs bg-red-500/5 rounded-xl">CERRAR SESIÓN</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-20 glass border-b border-slate-800 px-8 flex items-center justify-between">
                <h2 id="view-title" class="text-xl font-black uppercase italic">Dashboard</h2>
                <div class="text-right">
                    <p id="u-name" class="text-yellow-500 text-[10px] font-black uppercase"></p>
                    <p id="u-comp" class="text-slate-500 text-[9px] font-bold uppercase"></p>
                </div>
            </header>
            <div id="content" class="flex-1 overflow-y-auto p-8 custom-scroll"></div>
        </main>
    </section>

    <div id="modal-container" class="hidden fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div id="modal-content" class="glass w-full max-w-lg p-8 rounded-[2.5rem]"></div>
    </div>

    <script>
        const SB_URL = 'https://itahtywhhaecjakgtnzu.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0YWh0eXdoaGFlY2pha2d0bnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMjYyODIsImV4cCI6MjA4NTkwMjI4Mn0.ARQ9W_Rpj8rp_xo88TbTjbdwT6o75J7sCPlConcoshw';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        const State = {
            user: null,
            currentView: 'dashboard',
            cart: []
        };

        const App = {
            async login(e) {
                e.preventDefault();
                const u = document.getElementById('user').value;
                const p = document.getElementById('pass').value;

                if(u === 'admin@detailgest.com' && p === 'master2026') {
                    State.user = { id: 'master', username: 'Super Admin', role: 'super_admin', company_id: 'all' };
                } else {
                    const { data } = await sb.from('users').select('*, companies(*)').eq('username', u).eq('password_hash', p).single();
                    if(!data) return alert("Credenciales incorrectas");
                    State.user = data;
                }
                this.start();
            },

            start() {
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('u-name').innerText = State.user.username;
                document.getElementById('u-comp').innerText = State.user.companies?.name || 'ADMINISTRACIÓN';
                this.buildMenu();
                this.navigate('dashboard');
            },

            buildMenu() {
                const items = [
                    { id: 'dashboard', n: 'Dashboard', i: 'fa-chart-pie' },
                    { id: 'caja', n: 'Caja POS', i: 'fa-cash-register' },
                    { id: 'agenda', n: 'Agenda', i: 'fa-calendar-alt' },
                    { id: 'clientes', n: 'Clientes', i: 'fa-users' },
                    { id: 'servicios', n: 'Servicios', i: 'fa-tags' }
                ];
                document.getElementById('menu').innerHTML = items.map(m => `
                    <div onclick="App.navigate('${m.id}')" id="nav-${m.id}" class="sidebar-item">
                        <i class="fas ${m.i} w-5"></i> ${m.n}
                    </div>
                `).join('');
            },

            navigate(v) {
                State.currentView = v;
                document.getElementById('view-title').innerText = v;
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.toggle('active', el.id === `nav-${v}`));
                this.render();
            },

            async render() {
                const container = document.getElementById('content');
                container.innerHTML = '<p class="animate-pulse text-yellow-500 font-black">CARGANDO...</p>';

                if(State.currentView === 'dashboard') Views.dashboard(container);
                if(State.currentView === 'caja') Views.caja(container);
                if(State.currentView === 'agenda') Views.agenda(container);
                if(State.currentView === 'clientes') Views.clientes(container);
                if(State.currentView === 'servicios') Views.servicios(container);
            }
        };

        const Views = {
            async dashboard(c) {
                const { data: sales } = await sb.from('sales').select('*').eq('company_id', State.user.company_id);
                const total = sales?.reduce((a, b) => a + b.total_final, 0) || 0;
                c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="glass p-8 rounded-3xl">
                            <h4 class="text-slate-500 text-xs font-black uppercase mb-2 tracking-widest">Ventas Totales</h4>
                            <p class="text-4xl font-black">${total.toLocaleString()} Gs</p>
                        </div>
                        <div class="glass p-8 rounded-3xl">
                            <h4 class="text-slate-500 text-xs font-black uppercase mb-2 tracking-widest">Servicios</h4>
                            <p class="text-4xl font-black">${sales?.length || 0}</p>
                        </div>
                    </div>
                    <div class="glass p-8 rounded-[2rem] h-80"><canvas id="chart"></canvas></div>`;
                new Chart(document.getElementById('chart'), {
                    type: 'line',
                    data: {
                        labels: sales.map(s => s.created_at.slice(5,10)).slice(-7),
                        datasets: [{ label: 'Ingresos', data: sales.map(s => s.total_final).slice(-7), borderColor: '#eab308', tension: 0.4 }]
                    }
                });
            },

            async caja(c) {
                const [s, cl] = await Promise.all([
                    sb.from('services_list').select('*').eq('company_id', State.user.company_id),
                    sb.from('clients').select('*').eq('company_id', State.user.company_id)
                ]);
                c.innerHTML = `
                    <div class="flex flex-col lg:flex-row gap-8">
                        <div class="flex-1 grid grid-cols-2 gap-4">
                            ${s.data.map(i => `<button onclick="Pos.add('${i.name}', ${i.price})" class="glass p-6 rounded-2xl font-black text-xs hover:border-yellow-500 uppercase">${i.name}<br><span class="text-xl">${i.price.toLocaleString()}</span></button>`).join('')}
                        </div>
                        <div class="w-full lg:w-80 glass p-6 rounded-3xl h-fit">
                            <select id="p-cli" class="mb-4"><option value="">CONSUMIDOR FINAL</option>${cl.data.map(cli => `<option value="${cli.id}">${cli.name}</option>`)}</select>
                            <div id="p-cart" class="border-y border-white/5 py-4 my-4 space-y-2 text-[10px] font-bold uppercase"></div>
                            <div class="text-2xl font-black mb-6 italic" id="p-total">0 Gs</div>
                            <button onclick="Pos.pay()" class="w-full bg-yellow-500 text-black py-4 rounded-xl font-black uppercase">Cobrar Ahora</button>
                        </div>
                    </div>`;
                State.cart = [];
            },

            async agenda(c) {
                const { data } = await sb.from('sales').select('*, clients(name)').eq('company_id', State.user.company_id).order('created_at', {ascending: false});
                c.innerHTML = `<div class="space-y-4">${data.map(s => `
                    <div class="glass p-6 rounded-2xl flex justify-between items-center border-l-4 border-yellow-500">
                        <div>
                            <p class="text-[9px] text-slate-500 font-black">${s.created_at.slice(0,16)}</p>
                            <h4 class="font-black uppercase">${s.clients?.name || 'VENTA RÁPIDA'}</h4>
                            <p class="text-xs text-yellow-500 font-bold">${s.details}</p>
                        </div>
                        <div class="text-xl font-black">${s.total_final.toLocaleString()} Gs</div>
                    </div>`).join('')}</div>`;
            },

            async clientes(c) {
                const { data } = await sb.from('clients').select('*').eq('company_id', State.user.company_id);
                c.innerHTML = `
                    <button onclick="UI.modal('client')" class="bg-yellow-500 text-black px-6 py-2 rounded-xl mb-6 font-black text-xs uppercase">Nuevo Cliente</button>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">${data.map(cl => `<div class="glass p-4 rounded-xl font-black uppercase text-xs"><div>${cl.name}</div><div class="text-slate-500">${cl.phone}</div></div>`).join('')}</div>`;
            },

            async servicios(c) {
                const { data } = await sb.from('services_list').select('*').eq('company_id', State.user.company_id);
                c.innerHTML = `
                    <button onclick="UI.modal('service')" class="bg-yellow-500 text-black px-6 py-2 rounded-xl mb-6 font-black text-xs uppercase">Nuevo Servicio</button>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${data.map(sv => `<div class="glass p-4 rounded-xl text-center font-black uppercase text-xs"><div>${sv.name}</div><div class="text-yellow-500 text-lg">${sv.price.toLocaleString()}</div></div>`).join('')}</div>`;
            }
        };

        const Pos = {
            add(n, p) { State.cart.push({n, p}); this.upd(); },
            upd() {
                document.getElementById('p-cart').innerHTML = State.cart.map(i => `<div>${i.n}</div>`).join('');
                document.getElementById('p-total').innerText = State.cart.reduce((a,b) => a + b.p, 0).toLocaleString() + ' Gs';
            },
            async pay() {
                const total = State.cart.reduce((a,b) => a + b.p, 0);
                if(!total) return;
                await sb.from('sales').insert([{ company_id: State.user.company_id, total_final: total, details: State.cart.map(i => i.n).join(', '), client_id: document.getElementById('p-cli').value || null }]);
                App.navigate('caja');
            }
        };

        const UI = {
            modal(type) {
                const m = document.getElementById('modal-container');
                const c = document.getElementById('modal-content');
                m.classList.remove('hidden');
                if(type === 'client') {
                    c.innerHTML = `<h3 class="font-black mb-4 uppercase">Nuevo Cliente</h3><input id="cn" placeholder="Nombre" class="mb-2"><input id="cp" placeholder="Teléfono" class="mb-4"><button onclick="UI.saveCli()" class="w-full bg-yellow-500 text-black py-4 rounded-xl font-black uppercase">Guardar</button>`;
                }
                if(type === 'service') {
                    c.innerHTML = `<h3 class="font-black mb-4 uppercase">Nuevo Servicio</h3><input id="sn" placeholder="Nombre" class="mb-2"><input id="sp" type="number" placeholder="Precio" class="mb-4"><button onclick="UI.saveSer()" class="w-full bg-yellow-500 text-black py-4 rounded-xl font-black uppercase">Crear</button>`;
                }
            },
            async saveCli() {
                await sb.from('clients').insert([{ name: document.getElementById('cn').value, phone: document.getElementById('cp').value, company_id: State.user.company_id }]);
                document.getElementById('modal-container').classList.add('hidden');
                App.navigate('clientes');
            },
            async saveSer() {
                await sb.from('services_list').insert([{ name: document.getElementById('sn').value, price: document.getElementById('sp').value, company_id: State.user.company_id }]);
                document.getElementById('modal-container').classList.add('hidden');
                App.navigate('servicios');
            }
        }
    </script>
</body>
</html>