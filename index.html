<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DetailGest Magnus v11.0 | Enterprise Full</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --accent: #eab308; --bg: #060910; }
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: var(--bg); color: #f1f5f9; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* SIDEBAR DINÁMICO */
        #sidebar { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; }
        @media (max-width: 1024px) {
            #sidebar { position: fixed; transform: translateX(-100%); width: 280px; height: 100vh; }
            #sidebar.open { transform: translateX(0); }
        }
        .sidebar-item { padding: 0.8rem 1.2rem; margin: 0.2rem 0.5rem; border-radius: 1rem; display: flex; align-items: center; gap: 12px; cursor: pointer; color: #94a3b8; font-weight: 600; font-size: 13px; transition: 0.3s; }
        .sidebar-item.active { background: var(--accent); color: #000; }
        
        /* INPUTS ESTILO PREMIUM */
        input, select, textarea { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; border-radius: 12px; padding: 12px; font-size: 14px; width: 100%; outline: none; }
        input:focus { border-color: var(--accent) !important; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .view-animate { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="overlay" class="fixed inset-0 bg-black/60 hidden z-[90] backdrop-blur-sm" onclick="Core.toggleSidebar()"></div>

    <section id="login-view" class="h-full flex items-center justify-center p-6 bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-yellow-900/20 via-slate-950 to-black">
        <div class="max-w-md w-full glass p-10 rounded-[2.5rem] border-t-4 border-yellow-500 shadow-2xl text-center">
            <h1 class="text-5xl font-black text-yellow-500 italic tracking-tighter mb-2">MAGNUS</h1>
            <p class="text-slate-500 font-bold text-[10px] uppercase tracking-[0.3em] mb-8">DetailGest Enterprise</p>
            <form onsubmit="Auth.login(event)" class="space-y-4">
                <input type="text" id="log-user" placeholder="Usuario" required>
                <input type="password" id="log-pass" placeholder="Contraseña" required>
                <button type="submit" class="w-full bg-yellow-500 text-black font-extrabold py-4 rounded-2xl uppercase tracking-tight hover:brightness-110">Acceder al Sistema</button>
            </form>
        </div>
    </section>

    <section id="app-view" class="hidden h-screen flex">
        <aside id="sidebar" class="glass w-64 border-r border-slate-800 flex flex-col py-6 shrink-0">
            <div class="px-8 mb-10 flex justify-between items-center">
                <h2 class="text-yellow-500 font-black text-2xl italic">DG</h2>
                <button onclick="Core.toggleSidebar()" class="lg:hidden text-white"><i class="fas fa-times"></i></button>
            </div>
            <nav id="nav-menu" class="flex-1 overflow-y-auto custom-scroll"></nav>
            <div class="px-4 mt-auto">
                <button onclick="location.reload()" class="w-full p-4 text-red-500 font-bold text-xs flex items-center gap-3 bg-red-500/5 rounded-2xl hover:bg-red-500/10 transition-all">
                    <i class="fas fa-power-off"></i> CERRAR SESIÓN
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden bg-[#060910]">
            <header class="h-20 glass border-b border-slate-800 px-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="Core.toggleSidebar()" class="lg:hidden glass p-3 rounded-xl text-yellow-500"><i class="fas fa-bars"></i></button>
                    <h2 id="view-title" class="text-xl font-extrabold text-white uppercase italic tracking-tighter">Vista</h2>
                </div>
                <div class="hidden md:flex flex-col items-end">
                    <p id="user-tag" class="text-[10px] font-black text-yellow-500 uppercase"></p>
                    <p id="company-tag" class="text-[9px] text-slate-500 font-bold"></p>
                </div>
            </header>
            <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll view-animate"></div>
        </main>
    </section>

    <div id="modal-wrapper" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="UI.closeModal()"></div>
        <div id="modal-box" class="glass w-full max-w-lg p-8 rounded-[2.5rem] relative z-10"></div>
    </div>

    <script>
        const SB_URL = 'https://itahtywhhaecjakgtnzu.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0YWh0eXdoaGFlY2pha2d0bnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMjYyODIsImV4cCI6MjA4NTkwMjI4Mn0.ARQ9W_Rpj8rp_xo88TbTjbdwT6o75J7sCPlConcoshw';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let User = null;
        let Cart = [];

        const Core = {
            toggleSidebar(f) {
                const s = document.getElementById('sidebar');
                const o = document.getElementById('overlay');
                const open = s.classList.toggle('open', f);
                o.classList.toggle('hidden', !open);
            },
            async navigate(v) {
                document.getElementById('view-title').innerText = v;
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.toggle('active', i.id === `nav-${v}`));
                if(window.innerWidth < 1024) this.toggleSidebar(false);
                this.render(v);
            },
            async render(v) {
                const target = document.getElementById('main-content');
                target.innerHTML = `<div class="flex justify-center p-20 animate-pulse text-yellow-500 font-black">CARGANDO...</div>`;
                
                if(v === 'DASHBOARD') Views.dashboard(target);
                if(v === 'CAJA POS') Views.caja(target);
                if(v === 'AGENDA') Views.agenda(target);
                if(v === 'CLIENTES') Views.clientes(target);
                if(v === 'SERVICIOS') Views.servicios(target);
                if(v === 'PERSONAL') Views.personal(target);
                if(v === 'REPORTES') Views.reportes(target);
                if(v === 'AJUSTES') Views.ajustes(target);
            }
        };

        const Auth = {
            async login(e) {
                e.preventDefault();
                const u = document.getElementById('log-user').value;
                const p = document.getElementById('log-pass').value;
                const { data } = await sb.from('users').select('*, companies(*)').eq('username', u).eq('password_hash', p).single();
                if(data) {
                    User = data;
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('app-view').classList.remove('hidden');
                    document.getElementById('user-tag').innerText = User.username;
                    document.getElementById('company-tag').innerText = User.companies.name;
                    this.initMenu();
                    Core.navigate('DASHBOARD');
                } else { alert("Error de credenciales"); }
            },
            initMenu() {
                const menu = [
                    {n:'DASHBOARD', i:'fa-chart-pie'}, {n:'CAJA POS', i:'fa-cash-register'}, 
                    {n:'AGENDA', i:'fa-calendar-alt'}, {n:'CLIENTES', i:'fa-users'}, 
                    {n:'SERVICIOS', i:'fa-concierge-bell'}, {n:'PERSONAL', i:'fa-user-tie'}, 
                    {n:'REPORTES', i:'fa-file-invoice-dollar'}, {n:'AJUSTES', i:'fa-cog'}
                ];
                document.getElementById('nav-menu').innerHTML = menu.map(m => `
                    <div onclick="Core.navigate('${m.n}')" id="nav-${m.n}" class="sidebar-item"><i class="fas ${m.i} w-5"></i> ${m.n}</div>
                `).join('');
            }
        };

        const Views = {
            async dashboard(t) {
                const { data: sales } = await sb.from('sales').select('*').eq('company_id', User.company_id);
                const total = sales?.reduce((acc, s) => acc + s.total_final, 0) || 0;
                t.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="glass p-6 rounded-3xl border-l-4 border-yellow-500">
                            <p class="text-[10px] font-black text-slate-500 uppercase">Facturación Total</p>
                            <h3 class="text-3xl font-black">${total.toLocaleString()} Gs</h3>
                        </div>
                        <div class="glass p-6 rounded-3xl border-l-4 border-blue-500">
                            <p class="text-[10px] font-black text-slate-500 uppercase">Servicios Hoy</p>
                            <h3 class="text-3xl font-black">${sales?.length || 0}</h3>
                        </div>
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] h-80"><canvas id="dashChart"></canvas></div>`;
                
                const ctx = document.getElementById('dashChart');
                new Chart(ctx, { type: 'line', data: { labels: sales.map(s => s.created_at.slice(5,10)).slice(-7), datasets:[{ label:'Ingresos', data: sales.map(s => s.total_final).slice(-7), borderColor: '#eab308', tension: 0.4 }] } });
            },

            async caja(t) {
                const [sRes, cRes] = await Promise.all([
                    sb.from('services_list').select('*').eq('company_id', User.company_id),
                    sb.from('clients').select('*').eq('company_id', User.company_id)
                ]);
                t.innerHTML = `
                    <div class="flex flex-col lg:flex-row gap-6 h-full">
                        <div class="flex-1 grid grid-cols-2 md:grid-cols-3 gap-3 auto-rows-min">
                            ${sRes.data.map(s => `<button onclick="Pos.add('${s.name}', ${s.price})" class="glass p-6 rounded-2xl hover:border-yellow-500 active:scale-95 transition-all text-center uppercase font-bold text-[10px]">${s.name}<br><span class="text-xl font-black text-white">${Number(s.price).toLocaleString()}</span></button>`).join('')}
                        </div>
                        <div class="w-full lg:w-80 glass p-6 rounded-[2.5rem] flex flex-col h-fit">
                            <h4 class="text-yellow-500 font-black mb-4 italic uppercase text-sm">Resumen de Venta</h4>
                            <select id="pos-client" class="mb-4"><option value="">CONSUMIDOR FINAL</option>${cRes.data.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>
                            <div id="cart-box" class="flex-1 min-h-[150px] space-y-2 border-y border-white/5 py-4 mb-4 text-[11px] font-bold"></div>
                            <div class="flex justify-between text-xl font-black mb-6 italic text-white uppercase"><span>Total:</span><span id="pos-total">0 Gs</span></div>
                            <button onclick="Pos.pay()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase shadow-lg shadow-yellow-500/20">Finalizar Venta</button>
                        </div>
                    </div>`;
                Cart = [];
            },

            async agenda(t) {
                const { data } = await sb.from('sales').select('*, clients(name)').eq('company_id', User.company_id).order('created_at', {ascending: false});
                t.innerHTML = `<div class="space-y-3">${data.map(s => `
                    <div class="glass p-5 rounded-3xl flex justify-between items-center border-l-4 border-yellow-500">
                        <div>
                            <p class="text-[9px] font-black text-slate-500">${s.created_at.replace('T',' ').slice(0,16)}</p>
                            <h4 class="font-black text-white uppercase">${s.clients?.name || 'VENTA RÁPIDA'}</h4>
                            <p class="text-[10px] text-yellow-500 font-bold uppercase italic">${s.details}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-lg font-black">${s.total_final.toLocaleString()} Gs</span>
                            <button onclick="UI.editModal('${s.id}', '${s.details}', ${s.total_final})" class="text-blue-400 hover:text-white"><i class="fas fa-edit"></i></button>
                            <button onclick="UI.deleteSale('${s.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('')}</div>`;
            },

            async clientes(t) {
                const { data } = await sb.from('clients').select('*').eq('company_id', User.company_id);
                t.innerHTML = `
                    <div class="flex justify-end mb-6"><button onclick="UI.clientModal()" class="bg-yellow-500 text-black px-6 py-2 rounded-xl font-black text-xs uppercase">Nuevo Cliente</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">${data.map(c => `
                        <div class="glass p-5 rounded-2xl border-b border-white/5">
                            <h4 class="font-black text-white uppercase text-xs">${c.name}</h4>
                            <p class="text-[10px] text-slate-500 font-bold">${c.phone}</p>
                        </div>`).join('')}</div>`;
            },

            async servicios(t) {
                const { data } = await sb.from('services_list').select('*').eq('company_id', User.company_id);
                t.innerHTML = `
                    <div class="flex justify-end mb-6"><button onclick="UI.serviceModal()" class="bg-yellow-500 text-black px-6 py-2 rounded-xl font-black text-xs uppercase">Nuevo Servicio</button></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${data.map(s => `
                        <div class="glass p-5 rounded-2xl text-center">
                            <p class="text-[10px] font-black text-slate-500 uppercase">${s.name}</p>
                            <p class="text-xl font-black text-white">${s.price.toLocaleString()} Gs</p>
                        </div>`).join('')}</div>`;
            },

            async personal(t) {
                const { data } = await sb.from('users').select('*').eq('company_id', User.company_id).eq('role','empleado');
                t.innerHTML = `
                    <div class="flex justify-end mb-6"><button onclick="UI.staffModal()" class="bg-yellow-500 text-black px-6 py-2 rounded-xl font-black text-xs uppercase">Registrar Staff</button></div>
                    <div class="space-y-2">${data.map(e => `
                        <div class="glass p-4 rounded-xl flex justify-between items-center"><span class="font-black uppercase text-xs">${e.username}</span><span class="text-[10px] font-bold text-slate-500 uppercase">Operativo</span></div>
                    `).join('')}</div>`;
            },

            async reportes(t) {
                const hoy = new Date().toISOString().split('T')[0];
                const { data } = await sb.from('sales').select('*').eq('company_id', User.company_id).gte('created_at', hoy);
                const total = data.reduce((a,v) => a + v.total_final, 0);
                t.innerHTML = `
                    <div class="max-w-xl mx-auto glass p-10 rounded-[3rem] text-center border-t-8 border-yellow-500 shadow-2xl">
                        <p class="text-xs font-black text-slate-500 uppercase mb-4 tracking-widest">Ingresos de Hoy</p>
                        <h2 class="text-6xl font-black italic text-white mb-10">${total.toLocaleString()} Gs</h2>
                        <button onclick="window.print()" class="bg-white text-black font-black px-10 py-4 rounded-2xl text-xs uppercase">Exportar Reporte</button>
                    </div>`;
            },

            async ajustes(t) {
                t.innerHTML = `
                    <div class="max-w-md glass p-8 rounded-3xl">
                        <h3 class="font-black text-yellow-500 italic mb-6">DATOS DEL NEGOCIO</h3>
                        <div class="space-y-4">
                            <div><label class="text-[10px] font-bold text-slate-500">NOMBRE</label><input value="${User.companies.name}" disabled></div>
                            <button class="w-full bg-slate-800 text-white font-black py-4 rounded-xl text-xs uppercase">Cambiar Logo</button>
                        </div>
                    </div>`;
            }
        };

        const Pos = {
            add(n, p) { Cart.push({n, p}); this.upd(); },
            upd() {
                const box = document.getElementById('cart-box');
                const tot = document.getElementById('pos-total');
                box.innerHTML = Cart.map((i, x) => `<div class="flex justify-between uppercase"><span>${i.n}</span><button onclick="Pos.rem(${x})" class="text-red-500">X</button></div>`).join('');
                tot.innerText = Cart.reduce((a,b) => a + b.p, 0).toLocaleString() + ' Gs';
            },
            rem(x) { Cart.splice(x, 1); this.upd(); },
            async pay() {
                const total = Cart.reduce((a,b) => a + b.p, 0);
                if(!total) return;
                const { error } = await sb.from('sales').insert([{
                    company_id: User.company_id, total_final: total, 
                    details: Cart.map(i => i.n).join(', '), client_id: document.getElementById('pos-client').value || null
                }]);
                if(!error) { alert("Venta Exitosa"); Core.navigate('CAJA POS'); }
            }
        };

        const UI = {
            closeModal() { document.getElementById('modal-wrapper').classList.add('hidden'); },
            openModal(html) {
                const w = document.getElementById('modal-wrapper');
                const b = document.getElementById('modal-box');
                b.innerHTML = html;
                w.classList.remove('hidden');
            },
            clientModal() {
                this.openModal(`
                    <h3 class="font-black text-yellow-500 italic mb-6">NUEVO CLIENTE</h3>
                    <input id="nc-name" placeholder="Nombre completo" class="mb-2">
                    <input id="nc-phone" placeholder="Celular" class="mb-6">
                    <button onclick="UI.saveCli()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase">Registrar</button>
                `);
            },
            async saveCli() {
                await sb.from('clients').insert([{name: document.getElementById('nc-name').value, phone: document.getElementById('nc-phone').value, company_id: User.company_id}]);
                this.closeModal(); Core.navigate('CLIENTES');
            },
            serviceModal() {
                this.openModal(`
                    <h3 class="font-black text-yellow-500 italic mb-6">NUEVO SERVICIO</h3>
                    <input id="ns-name" placeholder="Nombre (Ej: Lavado Full)" class="mb-2">
                    <input id="ns-price" type="number" placeholder="Precio en Gs" class="mb-6">
                    <button onclick="UI.saveSer()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase">Crear Servicio</button>
                `);
            },
            async saveSer() {
                await sb.from('services_list').insert([{name: document.getElementById('ns-name').value, price: document.getElementById('ns-price').value, company_id: User.company_id}]);
                this.closeModal(); Core.navigate('SERVICIOS');
            },
            staffModal() {
                this.openModal(`
                    <h3 class="font-black text-yellow-500 italic mb-6">ACCESO PERSONAL</h3>
                    <input id="ne-user" placeholder="Nombre de usuario" class="mb-2">
                    <input id="ne-pass" type="password" placeholder="Contraseña" class="mb-6">
                    <button onclick="UI.saveStaff()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase">Habilitar</button>
                `);
            },
            async saveStaff() {
                await sb.from('users').insert([{username: document.getElementById('ne-user').value, password_hash: document.getElementById('ne-pass').value, role: 'empleado', company_id: User.company_id}]);
                this.closeModal(); Core.navigate('PERSONAL');
            },
            editModal(id, det, tot) {
                this.openModal(`
                    <h3 class="font-black text-yellow-500 mb-6">EDITAR VENTA</h3>
                    <input id="ed-det" value="${det}" class="mb-2">
                    <input id="ed-tot" type="number" value="${tot}" class="mb-6">
                    <button onclick="UI.updateSale('${id}')" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase">Actualizar</button>
                `);
            },
            async updateSale(id) {
                await sb.from('sales').update({details: document.getElementById('ed-det').value, total_final: document.getElementById('ed-tot').value}).eq('id', id);
                this.closeModal(); Core.navigate('AGENDA');
            },
            async deleteSale(id) { if(confirm("¿Borrar registro?")) { await sb.from('sales').delete().eq('id', id); Core.navigate('AGENDA'); } }
        };
    </script>
</body>
</html>